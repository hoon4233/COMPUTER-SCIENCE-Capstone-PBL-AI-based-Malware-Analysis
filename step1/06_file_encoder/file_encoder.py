import os
import time
import pickle
import numpy as np
from nltk.util import ngrams

MALWARE_PATH = "../data/opcode/malware/"
NORMAL_PATH = "../data/opcode/normal/"
VOCAB_PATH = "../03_vocab/vocab.pickle"
WHITELIST_PATH = "../04_whitelist/whitelist.pickle"
MAX_FILE_SIZE = 70000
N_OF_GRAMS = 3

def file_encoding(file_path, N):
    global MAX_FILE_SIZE
    with open(VOCAB_PATH, 'rb') as f:
        VOCAB = pickle.load(f)
    with open(WHITELIST_PATH, 'rb') as f:
        WHITELIST = pickle.load(f)

    with open(file_path, 'r') as f :
        result = np.zeros(MAX_FILE_SIZE)
        opcodes = f.readlines()
        n_gram = ngrams(opcodes, N)
        idx = 0
        for gram in n_gram :
            if idx == MAX_FILE_SIZE :
                break
            if gram in WHITELIST :
                continue
            try :
                result[idx] = float(VOCAB[gram])
            except KeyError :
                result[idx] = float(0)
            idx += 1
    return result

def testForOneFile():
    global MALWARE_PATH, N_OF_GRAMS
    files = [file for file in os.listdir(MALWARE_PATH) if file.endswith(".txt")]
    for file in files:
        with open('test_for_one_file.txt', 'w') as f:
            f.write(f"File_name : {file} \n")
            ret = list(file_encoding(MALWARE_PATH+file, N_OF_GRAMS))
            f.write(f"Entire : {ret} \n")
            f.write(f"Slicing : {ret[:6750]} \n")
        break

# 파이토치에서 학습데이터 어떻게 들고 있는지 찾아보고 해야할듯
def makeTrainingSet():
    pass

start_time = time.time()
testForOneFile()
with open('execution_time.txt', 'a') as f:
    f.write("Execution time :" + str(time.time()-start_time) + "\n")