import pandas as pd
import os
from collections import defaultdict
import time

MALWARE_PATH = "../data/opcode/malware/"
NORMAL_PATH = "../data/opcode/normal/"
RESULT_FILE_NAME = "data_analysis.xlsx"

def makeDataAnalysis(path, file_type):
    global RESULT_FILE_NAME
    result = {}
    files = [ file for file in os.listdir(path) if file.endswith(".txt") ]
    count = 0
    for file in files :
        if not file :
            continue
        count += 1
        with open(path+file, 'r') as f :
            file_to_opcodes = defaultdict(int)
            opcodes = f.readlines()
            for code in opcodes:
                file_to_opcodes[code.strip()] += 1
        result[file] = file_to_opcodes
        # if count == 10 :
        #     break

    result = pd.DataFrame.from_dict(result).T
    obj_sum = pd.Series(result.sum(axis=1),name="NUM_OF_ALL_OPCODE")
    result = pd.concat([obj_sum,result], axis=1)
    att_sum = pd.Series(result.sum(axis=0), name="SUM")
    result = result.append(att_sum)

    with open('meta_data.txt', 'a') as f :
        f.write(f"Number of columns (how many kinds of opcodes) about {file_type} : " + str(result.shape[1]) + "\n")
        f.write(f"Number of files (Not empty file) about {file_type} : " + str(count) + "\n")

    if not os.path.exists(RESULT_FILE_NAME):
        with pd.ExcelWriter(RESULT_FILE_NAME, mode='w') as W:
            result.to_excel(W, sheet_name=file_type)
    else :
        with pd.ExcelWriter(RESULT_FILE_NAME, mode='a') as W:
            result.to_excel(W, sheet_name=file_type)


start_time = time.time()
makeDataAnalysis(MALWARE_PATH, "Malware")
makeDataAnalysis(NORMAL_PATH, "Normal")
with open('meta_data.txt', 'a') as f:
    f.write("Execution time :" + str(time.time()-start_time) + "\n")
